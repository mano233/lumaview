<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>影调分析工具｜Histogram Tone Analyzer</title>
    <style>
        :root{ --bg:#0f1115; --panel:#151821; --panel-2:#1a1f2b; --text:#e6e8ee; --muted:#9aa3b2; --acc:#58a6ff; --acc-2:#8b5cf6; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --grid:#2a3040; --handle:#f8fafc; --shadow:#94a3b8; --mid:#60a5fa; --hi:#fca5a5; }
        html,body{height:100%; overflow-x:hidden;}
        body{margin:0;background:linear-gradient(180deg,#0e1117,#0c1018);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;min-height:100%;display:flex;flex-direction:column;}
        .wrap{width:100%;max-width:none;margin:0 auto;padding:24px 16px 16px;box-sizing:border-box}
        .title{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
        .title h1{font-size:20px;margin:0;}
        .panel{background:var(--panel);border:1px solid #232838;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.35);}
        .row{display:grid;grid-template-columns:minmax(0,1.2fr) minmax(0,.9fr);gap:16px;margin-top:16px}
        @media (max-width:1024px){.row{grid-template-columns:1fr;}}
        .uploader{padding:14px;border-radius:14px;border:1px dashed #2a3144;background:var(--panel-2);display:flex;align-items:center;gap:12px;justify-content:space-between;flex-wrap:wrap}
        .u-left{display:flex;align-items:center;gap:12px;}
        .actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
        .btn{background:#111827;border:1px solid #2b3348;color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer}
        .btn:hover{border-color:#3f4b6a}
        .pill{padding:6px 10px;border-radius:999px;border:1px solid #2b3348;background:#101625;color:var(--muted);font-size:12px}
        .imgPanel,.histPanel{flex:1;background:#0f1422;border:1px solid #22283a;border-radius:14px;min-width:0;overflow:hidden}
        .imgPanel header,.histPanel header{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid #22283a;color:var(--muted)}
        .cwrap{position:relative;padding:16px;}
        .canvasStack{position:relative;width:100%;}
        .canvasStack canvas{display:block;width:100%;height:auto;border-radius:12px;border:1px solid #1f2536;background:#0b1220;}
        .guideCanvas{position:absolute;inset:0;width:100%;height:100%;pointer-events:none;mix-blend-mode:screen;}
        canvas{display:block;width:100%;height:auto}
        .meta{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;padding:12px;border-top:1px solid #22283a;background:linear-gradient(180deg,#0a0f1a,#0e1422)}
        .stat{background:#0a101b;border:1px solid #1f2434;padding:10px;border-radius:10px;min-width:0}
        .stat h4{margin:0 0 8px 0;font-size:12px;color:var(--muted)}
        .stat b{font-size:18px;word-break:break-all}
        .paletteGrid{display:flex;flex-direction:column;gap:8px;min-height:56px}
        .paletteItem{display:flex;align-items:center;gap:10px;padding:6px 8px;border-radius:8px;border:1px solid #1f2536;background:#0b1220}
        .paletteSwatch{width:32px;height:32px;border-radius:8px;border:1px solid rgba(255,255,255,0.12)}
        .paletteLabel{display:flex;flex-direction:column;font-size:12px;color:#cbd5f5}
        .paletteLabel span:last-child{color:#7f8ca8;font-size:11px}
        .paletteEmpty{color:#3b455c;font-size:12px}
        .legend{display:flex;gap:12px;align-items:center;padding:10px 14px;border-top:1px solid #22283a;color:var(--muted);flex-wrap:wrap}
        .dot{width:10px;height:10px;border-radius:50%}
        .dot.shadow{background:var(--shadow)} .dot.mid{background:var(--mid)} .dot.hi{background:var(--hi)}
        .switch{display:inline-flex;gap:8px;align-items:center;padding:8px 10px;border-radius:10px;border:1px solid #2a3144;background:#0f1422;color:var(--muted);cursor:pointer}
        .switch input{accent-color:var(--acc)}
        .select{padding:9px 12px;border-radius:10px;border:1px solid #2a3144;background:#0f1422;color:var(--muted);appearance:none;font-size:13px;cursor:pointer;min-width:160px}
        .select:focus{outline:2px solid rgba(88,166,255,0.45);outline-offset:1px}
        .select option{background:#0f1422;color:var(--muted)}
        .handleTip{position:absolute;top:4px;transform:translateX(-50%);padding:2px 6px;background:#0b1220;border:1px solid #2a2f42;border-radius:6px;color:#aab3c4;font-size:11px;pointer-events:none}
        .toneTag{font-weight:600;padding:4px 8px;border-radius:8px;border:1px solid #2a3144;display:inline-block}
        .tone-low{color:#a5b4fc;border-color:#475569} .tone-mid{color:#67e8f9;border-color:#164e63} .tone-high{color:#fecaca;border-color:#7f1d1d}
        .footer{margin:18px 0 8px;color:#7a8497;font-size:12px;text-align:center}
        .busyOverlay{position:fixed;inset:0;background:rgba(4,6,12,.72);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;z-index:9999}
        .busyCard{width:min(440px,92vw);background:#0f1422;border:1px solid #22283a;border-radius:14px;box-shadow:0 12px 40px rgba(0,0,0,.45);padding:18px}
        .busyHead{display:flex;align-items:center;gap:10px;margin-bottom:12px;color:#c9d2e3}
        .spinner{width:18px;height:18px;border:3px solid #334155;border-top-color:#60a5fa;border-radius:50%;animation:spin 1s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .pbar{height:10px;border-radius:999px;background:#0b1220;border:1px solid #1f2536;overflow:hidden}
        .pbar>div{height:100%;width:0%;background:linear-gradient(90deg,#60a5fa,#22c55e);transition:width .12s ease}
        .pmemo{display:flex;align-items:center;justify-content:space-between;margin-top:8px;font-size:12px;color:#9aa3b2}
        .imgPanel.drag{outline:2px dashed var(--acc); outline-offset:-6px}
    </style>
</head>
<body>
<div class="wrap">
    <div class="title">
        <h1>影调分析工具</h1>
        <span class="pill">上传图片 → 生成直方图 → 拖拽阈值查看影调</span>
    </div>

    <div class="panel uploader" id="dropArea">
        <div class="u-left">
            <div>
                <div style="font-weight:600">加载图片</div>
                <div style="font-size:12px;color:var(--muted)">支持拖拽到预览窗口，或选择文件（JPG/PNG/WebP 等）</div>
            </div>
        </div>
        <div class="actions">
            <input type="file" accept="image/*" id="fileInput" style="display:none"/>
            <button class="btn" id="pickBtn">选择文件</button>
            <label class="switch"><input type="checkbox" id="rgbMode"> RGB 模式</label>
            <label class="switch"><input type="checkbox" id="showZones" checked> 显示影调分区</label>
            <label class="switch"><input type="checkbox" id="clipWarn" checked> 高光/暗部溢出提示</label>
            <select id="guideType" class="select">
                <option value="none">构图辅助线：关闭</option>
                <option value="thirds">九宫格（三分法）</option>
                <option value="goldenRatio">黄金比例网格</option>
                <option value="goldenSpiralTL">黄金螺旋（左上）</option>
                <option value="goldenSpiralTR">黄金螺旋（右上）</option>
                <option value="goldenSpiralBR">黄金螺旋（右下）</option>
                <option value="goldenSpiralBL">黄金螺旋（左下）</option>
                <option value="diagonal">对角线法</option>
                <option value="diagonalCross">对角交叉</option>
                <option value="goldenTriangleLeft">黄金三角（左向）</option>
                <option value="goldenTriangleRight">黄金三角（右向）</option>
            </select>
        </div>
    </div>

    <div class="row">
        <div class="panel imgPanel">
            <header>
                <span>图片预览</span>
                <span id="imgInfo" class="pill">未加载</span>
            </header>
            <div class="cwrap">
                <div class="canvasStack">
                    <canvas id="imgCanvas" data-aspect="0.65"></canvas>
                    <canvas id="guideCanvas" class="guideCanvas"></canvas>
                </div>
            </div>
            <div class="meta">
                <div class="stat"><h4>均值亮度</h4><b id="meanL">—</b></div>
                <div class="stat"><h4>中位亮度</h4><b id="medianL">—</b></div>
                <div class="stat"><h4>影调判断</h4><b id="toneJudge">—</b></div>
                <div class="stat"><h4>主色调</h4><div id="dominantPalette" class="paletteGrid"><span class="paletteEmpty">—</span></div></div>
            </div>
        </div>

        <div class="panel histPanel">
            <header>
                <span>亮度直方图（可拖拽两条阈值线）</span>
                <span class="pill">左 = 暗部 / 右 = 高光</span>
            </header>
            <div class="cwrap" style="padding-bottom:6px">
                <canvas id="histCanvas" data-aspect="0.325" style="background:#0b1220;border-radius:12px;border:1px solid #1f2536"></canvas>
                <div id="hTipL" class="handleTip" style="display:none">-</div>
                <div id="hTipR" class="handleTip" style="display:none">-</div>
            </div>
            <div class="legend">
                <div style="display:flex;align-items:center;gap:8px"><span class="dot shadow"></span> 暗部 <b id="shadowPct">—</b></div>
                <div style="display:flex;align-items:center;gap:8px"><span class="dot mid"></span> 中间调 <b id="midPct">—</b></div>
                <div style="display:flex;align-items:center;gap:8px"><span class="dot hi"></span> 高光 <b id="highlightPct">—</b></div>
                <div style="margin-left:auto">峰值计数 <span class="pill" id="peakCount">—</span></div>
            </div>
        </div>
    </div>

    <div class="footer">提示：拖拽直方图上的两条竖线可自定义暗部/高光阈值；支持切换 RGB 模式查看分通道直方图。</div>
</div>

<!-- Busy Overlay -->
<div id="busy" class="busyOverlay">
    <div class="busyCard">
        <div class="busyHead"><div class="spinner"></div><div id="busyTitle">Processing image…</div></div>
        <div class="pbar"><div id="busyBar"></div></div>
        <div class="pmemo"><span id="busyNote">Reading pixels…</span><span id="busyPct">0%</span></div>
    </div>
</div>

<!-- 外链脚本：将下方 app.js 内容另存为同目录文件 -->
<script src="app.js"></script>
</body>
</html>


